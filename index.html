<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Translate - VegaDLeonele</title>
    
    <!-- React & Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Generative AI SDK -->
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&family=Outfit:wght@700;800&display=swap');

        body { font-family: 'Inter', sans-serif; background-color: #fef2f2; color: #1a1a1a; } /* Nền hồng nhạt */
        .chinese-font { font-family: 'Noto Sans SC', sans-serif; }
        .title-font { font-family: 'Outfit', sans-serif; }
        .bg-pattern {
            background-color: #fef2f2; /* Nền hồng nhạt */
            opacity: 0.6; /* Tăng độ rõ của pattern */
            /* Pattern chấm đỏ */
            background-image:  radial-gradient(#dc2626 0.7px, transparent 0.7px), radial-gradient(#dc2626 0.7px, #fef2f2 0.7px);
            background-size: 24px 24px;
            background-position: 0 0,12px 12px;
        }
        @keyframes slide-up { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slide-up 0.4s ease-out forwards; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="h-screen w-full overflow-hidden flex justify-center bg-red-50 relative">

    <div class="absolute inset-0 bg-pattern pointer-events-none"></div>
    <div id="root" class="relative z-10 h-full w-full max-w-md bg-white shadow-2xl flex flex-col overflow-hidden border-x border-red-100"></div>

    <script type="text/babel" data-type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        const { useState, useEffect, useRef } = React;

        // =========================================================================
        // ▼ QUAN TRỌNG: DÁN KEY VÀO GIỮA 2 DẤU NGOẶC KÉP BÊN DƯỚI ▼
        // =========================================================================
        const HARD_CODED_API_KEY = "AIzaSyBHB0pPYBEXsXdDTs8OsaF5iTEqqqlPHNE"; 
        // =========================================================================

        const OFFLINE_DICT = {
            "你好": { pinyin: "Nǐ hǎo", hanviet: "Nhĩ hảo", meaning: "Xin chào", analysis: [], grammar: "Câu chào cơ bản.", sentence_structure: {}, examples: [] }
        };

        const SYSTEM_PROMPT = `Phân tích văn bản tiếng Trung, trả về JSON thuần (không markdown): { "pinyin": "", "hanviet": "", "meaning": "", "analysis": [], "grammar": "", "sentence_structure": {}, "examples": [], "correction": "", "slang": "" }`;

        const Header = ({ onSettingsClick, hasKey }) => (
            // Đổi gradient sang màu đỏ
            <div className="bg-gradient-to-br from-red-900 to-red-700 pt-8 pb-10 px-6 rounded-b-[2.5rem] relative shadow-xl shrink-0">
                <div className="absolute top-3 left-1/2 -translate-x-1/2 opacity-40 text-[10px] text-white uppercase tracking-[0.3em] font-light z-20">By VegaDLeonele</div>
                <div className="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-8 -mt-8 blur-2xl"></div>
                <div className="flex justify-between items-center relative z-10 text-white mt-2">
                    <div>
                        {/* Tiêu đề gradient trắng-đỏ nhạt */}
                        <h1 className="text-3xl font-extrabold title-font tracking-wide uppercase bg-clip-text text-transparent bg-gradient-to-r from-white to-red-200">AI Translate</h1>
                        {/* Gạch chân màu đỏ */}
                        <div className="h-1 w-12 bg-red-400 rounded-full mt-1"></div>
                    </div>
                    <button onClick={onSettingsClick} className="bg-black/20 p-2 rounded-full hover:bg-black/30 backdrop-blur-sm transition border border-white/10">
                        {/* Icon settings màu đỏ nhạt hoặc xanh lá khi có key */}
                        <i data-lucide={hasKey ? "key-round" : "settings-2"} className={`w-5 h-5 ${hasKey ? "text-green-400" : "text-red-100"}`}></i>
                    </button>
                </div>
            </div>
        );

        const App = () => {
            const [text, setText] = useState("");
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            const [apiKey, setApiKey] = useState(HARD_CODED_API_KEY || "");
            const [showSetup, setShowSetup] = useState(false);
            const [tab, setTab] = useState("meaning");

            useEffect(() => { lucide.createIcons(); }, [result, showSetup]);

            const handleTranslate = async () => {
                if (!text.trim()) return;
                if (OFFLINE_DICT[text.trim()]) { setResult(OFFLINE_DICT[text.trim()]); return; }

                if (!apiKey) { 
                    alert("Chưa tìm thấy API Key! Hãy dán Key vào code hoặc nhập trong cài đặt."); 
                    setShowSetup(true); 
                    return; 
                }

                setLoading(true);
                setResult(null);
                
                try {
                    const genAI = new GoogleGenerativeAI(apiKey);
                    // SỬA LỖI: Đổi sang model 'gemini-2.5-flash' để tránh lỗi 404
                    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
                    
                    console.log("Đang gửi request tới Google (Model: gemini-2.5-flash)...");
                    const res = await model.generateContent(`${SYSTEM_PROMPT}\n\nVăn bản: "${text}"`);
                    const responseText = res.response.text();
                    console.log("Nhận phản hồi:", responseText);

                    const jsonText = responseText.replace(/```json|```/g, "").trim();
                    setResult(JSON.parse(jsonText));

                } catch (e) {
                    console.error("Lỗi chi tiết:", e);
                    let msg = `Lỗi kết nối AI!\n\nChi tiết: ${e.message || e.toString()}`;
                    
                    if (e.message.includes("404")) msg += "\n\nLÝ DO: Model không tìm thấy. Đã tự động chuyển về gemini-2.5-flash.";
                    if (e.message.includes("403")) msg += "\n\nLÝ DO: Key sai hoặc vị trí địa lý bị chặn.";
                    if (e.message.includes("400")) msg += "\n\nLÝ DO: Key không hợp lệ (API_KEY_INVALID).";

                    alert(msg);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="flex flex-col h-full bg-red-50">
                    <Header onSettingsClick={() => setShowSetup(true)} hasKey={!!apiKey} />
                    
                    <div className="flex-1 overflow-y-auto px-4 py-6 -mt-8 z-20 no-scrollbar pb-20">
                        <div className="bg-white p-5 rounded-2xl shadow-lg border border-red-100 mb-6">
                            <textarea className="w-full text-xl chinese-font outline-none resize-none text-gray-800 placeholder-red-300 bg-transparent" rows="2" placeholder="Nhập tiếng Trung..." value={text} onChange={(e) => setText(e.target.value)}></textarea>
                            <div className="flex justify-end mt-3 pt-3 border-t border-dashed border-red-100">
                                {/* Nút dịch màu đỏ đậm */}
                                <button onClick={handleTranslate} disabled={loading} className="bg-red-900 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg active:scale-95 transition flex items-center gap-2 disabled:opacity-50 hover:bg-red-800">
                                    {loading ? "Đang xử lý..." : "Dịch Ngay"} <i data-lucide="sparkles" className="w-4 h-4 text-yellow-400"></i>
                                </button>
                            </div>
                        </div>

                        {/* Loading spinner màu đỏ */}
                        {loading && <div className="flex flex-col items-center py-8"><div className="w-12 h-12 border-4 border-red-100 border-t-red-600 rounded-full animate-spin mb-3"></div><p className="text-sm text-red-500">Đang phân tích...</p></div>}
                        
                        {result && !loading && (
                            <div className="bg-white rounded-2xl shadow-xl overflow-hidden animate-slide-up border border-red-100">
                                <div className="flex border-b border-red-100 bg-red-50/50">
                                    {['meaning', 'analysis', 'grammar'].map(t => (
                                        // Tabs màu đỏ
                                        <button key={t} onClick={() => setTab(t)} className={`flex-1 py-3 text-sm font-medium transition ${tab === t ? 'text-red-800 border-b-2 border-red-800 bg-red-50/50' : 'text-gray-400 hover:text-red-600'}`}>{t === 'meaning' ? 'Ý Nghĩa' : t === 'analysis' ? 'Phân Tích' : 'Ngữ Pháp'}</button>
                                    ))}
                                </div>
                                <div className="p-5 min-h-[200px]">
                                    {tab === 'meaning' && (
                                        <div className="space-y-4">
                                            <div className="text-center pb-4 border-b border-red-100 border-dashed">
                                                <h2 className="text-3xl font-medium chinese-font text-gray-800">{text}</h2>
                                                <p className="text-gray-600 text-xs mt-2">{result.pinyin}</p>
                                                {/* Hán Việt màu đỏ */}
                                                <p className="text-red-800 font-bold uppercase text-sm">{result.hanviet}</p>
                                            </div>
                                            {/* Box nghĩa màu đỏ */}
                                            <div className="bg-red-50 p-4 rounded-xl border-l-4 border-red-800"><p className="text-gray-700 font-medium">{result.meaning}</p></div>
                                        </div>
                                    )}
                                    {tab === 'analysis' && <div className="space-y-3">{result.analysis?.map((item, i) => (<div key={i} className="flex gap-3 p-3 border border-red-100 rounded-xl hover:border-red-300 transition"><div className="w-10 h-10 bg-red-50 text-red-800 rounded-lg flex items-center justify-center text-xl font-medium chinese-font shrink-0">{item.char}</div><div><p className="font-bold text-gray-800 text-sm">{item.hanviet}</p><p className="text-xs text-gray-600">{item.meaning}</p></div></div>))}</div>}
                                    {/* Box ngữ pháp màu đỏ nhạt */}
                                    {tab === 'grammar' && <div className="text-sm text-gray-700 space-y-4"><div className="bg-red-50 p-3 rounded-lg text-red-900 border border-red-100">{result.grammar}</div></div>}
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {showSetup && (
                        <div className="absolute inset-0 z-50 bg-black/60 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 border border-red-100">
                                <h3 className="font-bold mb-2 text-red-900">Cài đặt Key</h3>
                                <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="Dán Key vào đây..." className="w-full p-2 border border-red-200 rounded mb-4 focus:outline-none focus:border-red-500"/>
                                <div className="flex gap-2"><button onClick={() => setShowSetup(false)} className="flex-1 p-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">Đóng</button><button onClick={() => setShowSetup(false)} className="flex-1 p-2 bg-red-800 text-white rounded hover:bg-red-700">Lưu</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

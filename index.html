<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Translate - VegaDLeonele</title>
    
    <!-- React & Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Generative AI SDK -->
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&family=Outfit:wght@700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0;
            color: #1a1a1a;
        }
        
        .chinese-font { 
            font-family: 'Noto Sans SC', sans-serif; 
        }
        
        .title-font {
            font-family: 'Outfit', sans-serif;
        }

        .bg-pattern {
            background-color: #e5e5f7;
            opacity: 0.4;
            background-image:  radial-gradient(#444cf7 0.5px, transparent 0.5px), radial-gradient(#444cf7 0.5px, #e5e5f7 0.5px);
            background-size: 20px 20px;
            background-position: 0 0,10px 10px;
        }
        
        @keyframes slide-up {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slide-up 0.4s ease-out forwards; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="h-screen w-full overflow-hidden flex justify-center bg-gray-100 relative">

    <div class="absolute inset-0 bg-pattern pointer-events-none"></div>

    <div id="root" class="relative z-10 h-full w-full max-w-md bg-white shadow-2xl flex flex-col overflow-hidden border-x border-gray-200"></div>

    <script type="text/babel" data-type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        const { useState, useEffect, useRef } = React;

        // =========================================================================
        // ▼ DÁN API KEY CỦA BẠN VÀO GIỮA HAI DẤU NGOẶC KÉP BÊN DƯỚI ▼
        // =========================================================================
        const HARD_CODED_API_KEY = "AIzaSyBHB0pPYBEXsXdDTs8OsaF5iTEqqqlPHNE"; 
        // Ví dụ: const HARD_CODED_API_KEY = "AIzaSyDxxxxxxxxxxxx";
        // =========================================================================

        // --- DỮ LIỆU MẪU OFFLINE ---
        const OFFLINE_DICT = {
            "你好": {
                pinyin: "Nǐ hǎo", hanviet: "Nhĩ hảo", meaning: "Xin chào",
                analysis: [
                    { char: "你", pinyin: "nǐ", hanviet: "Nhĩ", radical: "亻(Nhân)", meaning: "Bạn, ông, mày" },
                    { char: "好", pinyin: "hǎo", hanviet: "Hảo", radical: "女 (Nữ)", meaning: "Tốt, hay, đẹp" }
                ],
                grammar: "Câu chào hỏi cơ bản nhất.",
                sentence_structure: { subject: "你 (Bạn)", predicate: "好 (Tốt)" },
                examples: [{ cn: "你们好", vi: "Chào các bạn" }]
            }
        };

        // --- CẤU HÌNH AI ---
        const SYSTEM_PROMPT = `
        Bạn là chuyên gia ngôn ngữ Trung-Việt. 
        Phân tích văn bản tiếng Trung người dùng nhập và trả về JSON thuần túy (không dùng markdown block) theo cấu trúc:
        {
            "pinyin": "Phiên âm pinyin", 
            "hanviet": "Phiên âm Hán Việt", 
            "meaning": "Dịch nghĩa tiếng Việt hay và tự nhiên",
            "analysis": [{ "char": "Chữ Hán", "pinyin": "...", "hanviet": "...", "radical": "Bộ thủ", "meaning": "Nghĩa từ đơn" }],
            "grammar": "Giải thích ngữ pháp ngắn gọn, dễ hiểu",
            "sentence_structure": { "subject": "...", "predicate": "...", "object": "..." },
            "examples": [{ "cn": "...", "vi": "..." }],
            "correction": "Sửa lỗi sai nếu có (hoặc null)", 
            "slang": "Giải thích nếu là tiếng lóng (hoặc null)"
        }
        `;

        // --- COMPONENTS ---

        const Header = ({ onSettingsClick, hasKey }) => (
            <div className="bg-gradient-to-br from-indigo-900 to-blue-800 pt-8 pb-10 px-6 rounded-b-[2.5rem] relative shadow-xl shrink-0">
                <div className="absolute top-3 left-1/2 -translate-x-1/2 opacity-40 text-[10px] text-white uppercase tracking-[0.3em] font-light z-20">
                    By VegaDLeonele
                </div>
                <div className="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-8 -mt-8 blur-2xl"></div>
                <div className="flex justify-between items-center relative z-10 text-white mt-2">
                    <div>
                        <h1 className="text-3xl font-extrabold title-font tracking-wide uppercase bg-clip-text text-transparent bg-gradient-to-r from-white to-blue-200">
                            AI Translate
                        </h1>
                        <div className="h-1 w-12 bg-blue-400 rounded-full mt-1"></div>
                    </div>
                    <button onClick={onSettingsClick} className="bg-black/20 p-2 rounded-full hover:bg-black/30 backdrop-blur-sm transition border border-white/10">
                        <i data-lucide={hasKey ? "key-round" : "settings-2"} className={`w-5 h-5 ${hasKey ? "text-green-400" : "text-white"}`}></i>
                    </button>
                </div>
            </div>
        );

        const LoadingSpinner = () => (
            <div className="flex flex-col items-center py-8 animate-slide-up">
                <div className="w-12 h-12 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mb-3"></div>
                <p className="text-sm text-gray-500 font-medium">AI đang phân tích...</p>
            </div>
        );

        const SetupModal = ({ onClose, setApiKey, defaultKey }) => {
            const [keyInput, setKeyInput] = useState(defaultKey || "");

            const saveKey = () => {
                if(keyInput.length > 10) {
                    setApiKey(keyInput.trim());
                    onClose();
                } else {
                    alert("Mã Key quá ngắn, vui lòng kiểm tra lại.");
                }
            };

            return (
                <div className="absolute inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-slide-up">
                    <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                        <h3 className="text-lg font-bold text-gray-800 mb-2">Cài đặt API Key</h3>
                        <p className="text-sm text-gray-500 mb-4">
                            {HARD_CODED_API_KEY 
                                ? "Đang sử dụng Key được cài sẵn trong code." 
                                : "Chưa tìm thấy Key cài sẵn. Vui lòng nhập Key:"}
                        </p>
                        <input 
                            type="password"
                            value={keyInput}
                            onChange={(e) => setKeyInput(e.target.value)}
                            placeholder="Dán API Key (AIzaSy...)"
                            className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm mb-4 focus:outline-none focus:border-blue-800 transition"
                        />
                        <div className="flex gap-3">
                            <button onClick={onClose} className="flex-1 py-2.5 text-gray-500 font-medium text-sm hover:bg-gray-50 rounded-xl">Đóng</button>
                            <button onClick={saveKey} className="flex-1 py-2.5 bg-blue-700 text-white font-medium text-sm rounded-xl shadow-lg shadow-blue-200">Lưu Key</button>
                        </div>
                        <div className="mt-4 pt-4 border-t border-gray-100 text-center">
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-xs text-blue-600 hover:underline font-medium flex items-center justify-center gap-1">
                                Lấy API Key mới <i data-lucide="external-link" className="w-3 h-3"></i>
                            </a>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [text, setText] = useState("");
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            
            // --- SỬA LỖI CHÍNH: Ưu tiên HARD_CODED_API_KEY trước, sau đó mới tới localStorage ---
            const [apiKey, setApiKey] = useState(HARD_CODED_API_KEY || localStorage.getItem("gemini_key") || "");
            
            const [showSetup, setShowSetup] = useState(false);
            const [tab, setTab] = useState("meaning");

            useEffect(() => { lucide.createIcons(); }, [result, showSetup, apiKey]);
            
            useEffect(() => { 
                if (apiKey) localStorage.setItem("gemini_key", apiKey); 
            }, [apiKey]);

            const handleTranslate = async () => {
                if (!text.trim()) return;

                if (OFFLINE_DICT[text.trim()]) {
                    setLoading(true);
                    setTimeout(() => { setResult(OFFLINE_DICT[text.trim()]); setLoading(false); }, 500);
                    return;
                }

                if (!apiKey) {
                    setShowSetup(true);
                    return;
                }

                setLoading(true);
                setResult(null);
                try {
                    const genAI = new GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                    const res = await model.generateContent(`${SYSTEM_PROMPT}\n\nVăn bản: "${text}"`);
                    const jsonText = res.response.text().replace(/```json|```/g, "").trim();
                    setResult(JSON.parse(jsonText));
                } catch (e) {
                    console.error(e);
                    // Hiển thị thông báo lỗi chi tiết hơn
                    let errorMsg = "Lỗi kết nối AI!";
                    if (e.message.includes("400")) errorMsg = "Lỗi Key hoặc Cú pháp (400). Kiểm tra lại API Key.";
                    if (e.message.includes("403")) errorMsg = "Quyền truy cập bị từ chối (403). Key không hợp lệ.";
                    if (e.message.includes("fetch")) errorMsg = "Lỗi mạng. Kiểm tra kết nối internet.";
                    
                    alert(`${errorMsg}\nChi tiết: ${e.message}`);
                    setShowSetup(true);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="flex flex-col h-full bg-[#f8f9fa]">
                    <Header onSettingsClick={() => setShowSetup(true)} hasKey={!!apiKey} />
                    
                    <div className="flex-1 overflow-y-auto px-4 py-6 -mt-8 z-20 no-scrollbar pb-20">
                        <div className="bg-white p-5 rounded-2xl shadow-lg border border-gray-100 mb-6">
                            <textarea 
                                className="w-full text-xl chinese-font outline-none resize-none text-gray-800 placeholder-gray-300 bg-transparent" 
                                rows="2" 
                                placeholder="Nhập tiếng Trung..."
                                value={text}
                                onChange={(e) => setText(e.target.value)}
                            ></textarea>
                            <div className="flex justify-end mt-3 pt-3 border-t border-dashed border-gray-100">
                                <button 
                                    onClick={handleTranslate}
                                    disabled={loading}
                                    className="bg-blue-900 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg active:scale-95 transition flex items-center gap-2 disabled:opacity-50"
                                >
                                    {loading ? "Đang xử lý..." : "Dịch Ngay"} <i data-lucide="sparkles" className="w-4 h-4 text-yellow-400"></i>
                                </button>
                            </div>
                        </div>

                        {loading && <LoadingSpinner />}
                        
                        {result && !loading && (
                            <div className="bg-white rounded-2xl shadow-xl overflow-hidden animate-slide-up border border-gray-100">
                                <div className="flex border-b border-gray-100 bg-gray-50/50">
                                    {['meaning', 'analysis', 'grammar'].map(t => (
                                        <button 
                                            key={t}
                                            onClick={() => setTab(t)}
                                            className={`flex-1 py-3 text-sm font-medium transition ${tab === t ? 'text-blue-800 border-b-2 border-blue-800 bg-blue-50/50' : 'text-gray-400'}`}
                                        >
                                            {t === 'meaning' ? 'Ý Nghĩa' : t === 'analysis' ? 'Phân Tích' : 'Ngữ Pháp'}
                                        </button>
                                    ))}
                                </div>

                                <div className="p-5 min-h-[200px]">
                                    {tab === 'meaning' && (
                                        <div className="space-y-4">
                                            <div className="text-center pb-4 border-b border-gray-100 border-dashed">
                                                <h2 className="text-3xl font-medium chinese-font text-gray-800">{text}</h2>
                                                <div className="flex justify-center gap-2 mt-2">
                                                    <span className="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded font-mono">{result.pinyin}</span>
                                                    <span className="px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded font-bold uppercase">{result.hanviet}</span>
                                                </div>
                                            </div>
                                            
                                            <div className="bg-gray-50 p-4 rounded-xl border-l-4 border-blue-800">
                                                <p className="text-gray-700 font-medium leading-relaxed">{result.meaning}</p>
                                            </div>

                                            {result.examples && (
                                                <div className="pt-2">
                                                    <p className="text-xs font-bold text-gray-400 uppercase mb-2">Ví dụ</p>
                                                    {result.examples.map((ex, i) => (
                                                        <div key={i} className="text-sm mb-2">
                                                            <p className="chinese-font text-gray-800">{ex.cn}</p>
                                                            <p className="text-gray-500 italic">{ex.vi}</p>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {tab === 'analysis' && (
                                        <div className="space-y-3">
                                            {result.analysis?.map((item, i) => (
                                                <div key={i} className="flex gap-3 p-3 border border-gray-100 rounded-xl hover:border-blue-200 transition">
                                                    <div className="w-10 h-10 bg-blue-50 text-blue-800 rounded-lg flex items-center justify-center text-xl font-medium chinese-font shrink-0">
                                                        {item.char}
                                                    </div>
                                                    <div>
                                                        <div className="flex items-baseline gap-2">
                                                            <span className="font-bold text-gray-800 text-sm">{item.hanviet}</span>
                                                            <span className="text-xs text-gray-400 font-mono">{item.pinyin}</span>
                                                        </div>
                                                        <p className="text-xs text-gray-600 mt-1">{item.meaning}</p>
                                                        <span className="inline-block mt-1 text-[10px] px-1.5 py-0.5 bg-gray-100 text-gray-500 rounded">Bộ: {item.radical}</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    {tab === 'grammar' && (
                                        <div className="text-sm text-gray-700 space-y-4">
                                            <div className="grid grid-cols-2 gap-2">
                                                {result.sentence_structure && Object.entries(result.sentence_structure).map(([k, v]) => (
                                                    v && <div key={k} className="bg-gray-50 p-2 rounded border border-gray-100">
                                                        <span className="block text-[10px] text-gray-400 uppercase mb-1">{k}</span>
                                                        <span className="font-medium text-gray-800 chinese-font">{v}</span>
                                                    </div>
                                                ))}
                                            </div>
                                            <div className="bg-indigo-50 p-3 rounded-lg text-indigo-900 leading-relaxed">
                                                {result.grammar}
                                            </div>
                                            {result.correction && (
                                                <div className="bg-yellow-50 p-3 rounded-lg text-yellow-800 border border-yellow-100">
                                                    <span className="font-bold block text-xs uppercase mb-1">Gợi ý sửa lỗi:</span>
                                                    {result.correction}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {!result && !loading && (
                            <div className="text-center mt-12 opacity-50">
                                <i data-lucide="book-type" className="w-12 h-12 mx-auto text-gray-300 mb-2"></i>
                                <p className="text-sm text-gray-400">Sẵn sàng dịch thuật</p>
                            </div>
                        )}
                    </div>

                    {showSetup && <SetupModal onClose={() => setShowSetup(false)} setApiKey={setApiKey} defaultKey={HARD_CODED_API_KEY} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
